

#include <stdint.h>
#include <stddef.h>
#include <stdio.h>

#include <goertzel-dtmf.h>

/**
 * @brief 512 samples of a DTMF signal that corresponds to a '4' symbol.
 *        Sampled at 16kHz, and 12 bits. Source DTMF signal generated with
 *        Audacity, with 0.8 max amplitude. Played and sampled on an ESP32.
 */
static const uint16_t samples4_16kHz_512[] = {
    2131, 1927, 1791, 1807, 1855, 2019, 2175, 2303, 2303, 2161, 1880, 1536,
    1013, 693, 455, 410, 610, 1023, 1599, 2214, 2798, 3318, 3661, 3583, 3175,
    2623, 2079, 1536, 999, 671, 575, 688, 960, 1279, 1649, 1905, 2075, 2099,
    2013, 1880, 1791, 1710, 1732, 1855, 2103, 2386, 2639, 2784, 2763, 2525,
    2129, 1649, 1087, 595, 255, 176, 352, 745, 1279, 1935, 2544, 3072, 3408,
    3430, 3128, 2684, 2175, 1761, 1339, 1084, 1017, 1103, 1279, 1536, 1707,
    1789, 1791, 1728, 1561, 1396, 1279, 1328, 1536, 1809, 2175, 2591, 2975,
    3199, 3199, 2907, 2430, 1852, 1250, 663, 295, 127, 233, 569, 1087, 1712,
    2243, 2687, 2992, 3051, 2878, 2559, 2221, 1874, 1638, 1536, 1536, 1599,
    1740, 1840, 1895, 1840, 1695, 1445, 1151, 919, 810, 898, 1151, 1599, 2092,
    2623, 3125, 3520, 3570, 3245, 2737, 2111, 1536, 911, 472, 255, 304, 575,
    1017, 1536, 1969, 2303, 2550, 2591, 2479, 2275, 2048, 1855, 1791, 1787,
    1893, 2079, 2221, 2286, 2235, 2048, 1728, 1328, 911, 575, 432, 515, 795,
    1279, 1855, 2490, 3051, 3542, 3690, 3427, 2928, 2367, 1788, 1216, 803, 575,
    575, 775, 1103, 1536, 1835, 2009, 2127, 2101, 1991, 1847, 1753, 1728, 1791,
    1959, 2207, 2473, 2683, 2767, 2640, 2303, 1964, 1388, 844, 437, 207, 240,
    512, 1008, 1635, 2235, 2815, 3285, 3501, 3327, 2951, 2480, 1968, 1536,
    1183, 1010, 1003, 1136, 1368, 1593, 1760, 1807, 1807, 1663, 1536, 1376,
    1328, 1411, 1621, 1951, 2303, 2768, 3084, 3230, 3057, 2687, 2164, 1597,
    969, 461, 176, 127, 368, 799, 1387, 1951, 2483, 2853, 3080, 3025, 2795,
    2416, 2063, 1755, 1536, 1456, 1536, 1616, 1787, 1852, 1855, 1791, 1593,
    1279, 1077, 897, 851, 1020, 1359, 1807, 2303, 2863, 3323, 3568, 3456, 3004,
    2449, 1817, 1208, 669, 335, 247, 398, 738, 1237, 1758, 2163, 2480, 2611,
    2575, 2423, 2175, 1962, 1807, 1784, 1809, 1948, 2096, 2225, 2257, 2147,
    1891, 1566, 1151, 752, 512, 463, 624, 1023, 1575, 2160, 2767, 3302, 3667,
    3647, 3219, 2669, 2072, 1536, 1002, 639, 518, 622, 896, 1248, 1632, 1907,
    2097, 2160, 2096, 1959, 1803, 1752, 1753, 1840, 2055, 2303, 2559, 2687,
    2687, 2483, 2142, 1663, 1128, 639, 309, 207, 338, 719, 1279, 1914, 2515,
    3072, 3431, 3498, 3195, 2755, 2246, 1765, 1343, 1067, 960, 1011, 1203,
    1439, 1663, 1791, 1821, 1776, 1639, 1536, 1369, 1369, 1536, 1791, 2144,
    2535, 2913, 3155, 3147, 2895, 2439, 1855, 1279, 710, 305, 127, 207, 543,
    1082, 1662, 2224, 2687, 3024, 3116, 2959, 2639, 2257, 1901, 1633, 1456,
    1427, 1536, 1663, 1809, 1845, 1821, 1718, 1536, 1242, 996, 896, 943, 1151,
    1579, 2051, 2581, 3087, 3456, 3534, 3264, 2757, 2160, 1554, 944, 481, 249,
    255, 527, 953, 1467, 1943, 2303, 2591, 2656, 2544, 2303, 2104, 1904, 1791,
    1778, 1831, 1984, 2111, 2219, 2175, 2048, 1767, 1379, 965, 639, 472, 527,
    799, 1279, 1823, 2445, 3026, 3487, 3711, 3471, 2965, 2406, 1791, 1235, 784,
    560, 527, 693, 1023, 1425, 1791, 2048, 2171, 2171, 2070, 1923, 1791, 1749,
    1791, 1927, 2159, 2403, 2616, 2687, 2608, 2303, 1905, 1423, 665, 2533,
    2096, 1559, 995, 512, 224, 159, 359, 807, 1408, 2016, 2598, 3073, 3327,
    3327, 2993, 2591, 2111, 1712, 1374, 1151, 1139
};

int main()
{
    struct goertzel_dtmf_state dtmf;

    goertzel_dtmf_init(&dtmf, 16000, 512);

    for (size_t s = 0; s < 512; s++)
    {
        goertzel_dtmf_add_sample_pcm8(&dtmf, samples4_16kHz_512[s] >> 4);
    }

    char r = goertzel_dtmf_detect(&dtmf, 9500*9500, 9500*9500);
    if (r != '4')
    {
        printf("test failed! detected char should have been 4, and it was %d ('%c')\n", r, r);
    }
    else
    {
        printf("test passed! got char 4\n");
    }

    return (r == '4') ? 0 : 1;
}